{% set visibleMetadataNames = ['data_wydania'] %}
{% set collapsedMetadataNames = ['opis', 'abstrakt'] %}

{% set childrenAllowed = resource | childrenAllowed %}

<div class="resources-list-element">
    <a href="/resources/{{ resource.id }}">
        {% include 'redo/resource-image.twig' %}
    </a>
    {% if searchResult is defined %}
        {% set highlightedMetadata = [] %}
        {% for fieldName, highlights in searchResult.highlights %}
            {% set metadataId = fieldName | slice(9) | number_format %}
            {% set metadata = metadata(metadataId) %}
            {% set metadataLabel = metadata.label | inCurrentLanguage %}
            {% set highlightedMetadata = highlightedMetadata | merge({(metadata.name): {
                id: metadata.id,
                label: metadataLabel,
                control: metadata.control,
                highlights: highlights
            }}) %}
        {% endfor %}
    {% endif %}

    <div class="details">
        <div class="basic-data-with-download-options">
            <div class="basic-data">
                <h2>
                    <a href="/resources/{{ resource.id }}">
                        {% if highlightedMetadata is defined and highlightedMetadata.tytul is defined %}
                            {{ highlightedMetadata.tytul.highlights[0] | raw }}
                            {% set highlightedMetadata = arrayWithoutItem(highlightedMetadata, 'tytul') %}
                        {% else %}
                            {{ resource | metadata('tytul') | default(resource | metadata('label')) }}
                        {% endif %}
                    </a>
                </h2>
                {% if resource | metadata('autor') is not empty %}
                    <h4>{{ resource | metadata('autor') }}</h4>
                {% endif %}
                <div>
                    <span class="metadata-label">{{ 'Type'| trans }}:</span> {{ resource.kind.label | inCurrentLanguage }}
                </div>
                {% for visibleMetadataName in visibleMetadataNames %}
                    {% set metadata = metadata(visibleMetadataName) %}
                    {% if metadata %}
                        {% set metadataLabel = metadata.label | inCurrentLanguage %}
                        {% set metadataValue = resource | metadata(visibleMetadataName) %}
                        {% if metadataValue is not empty %}
                            <div>
                                <span class="metadata-label">{{ metadataLabel }}:</span> {{ metadataValue }}
                            </div>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
            {% if not childrenAllowed %}
                {% include 'redo/resource-details/download-formats.twig' %}
            {% endif %}
        </div>

        {% set collapsedMetadataLabelsWithValues = [] %}
        {% for collapsedMetadataName in collapsedMetadataNames %}
            {% set metadata = metadata(collapsedMetadataName) %}
            {% if metadata and (highlightedMetadata is not defined or highlightedMetadata[metadata.name] is not defined) %}
                {% set metadataLabel = metadata.label | inCurrentLanguage %}
                {% set metadataValue = resource | metadata(collapsedMetadataName) %}
                {% if metadataValue is not empty %}
                    {% set collapsedMetadataLabelsWithValues = collapsedMetadataLabelsWithValues| merge([{
                        label: metadataLabel,
                        value: metadataValue
                    }]) %}
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if collapsedMetadataLabelsWithValues is not empty or searchResult is defined and highlightedMetadata is not empty %}
        {% set variableName = "resource" ~ resource.id ~ "MetadataListExpanded" %}
        {% if searchResult is defined and highlightedMetadata is not empty %}
            {% for metadataName, metadataLabelWithHighlights in highlightedMetadata %}
                {% if metadataLabelWithHighlights.control == 'file' or metadataLabelWithHighlights.control == 'directory' %}
                    {% set highlights = withPageNumbers(resource, metadataLabelWithHighlights.control, resource | m(metadataLabelWithHighlights.id), metadataLabelWithHighlights.highlights) %}
                    {% set hasBrowsableContents = (resource | metadata('pliki_strona_po_stronie')) is not empty %}
                    {% for highlight in highlights %}
                        <div class="metadata-details">
                            <span class="metadata-label">{{ 'page' | trans }} {{ highlight.pageNumber }}</span>
                            {{ highlight.highlight | raw }}
                            {% if hasBrowsableContents %}
                                <a href="/resources/{{ resource.id }}/browse#page/{{ highlight.pageNumber }}">&raquo;</a>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="metadata-details">
                        <span class="metadata-label">{{ metadataLabelWithHighlights.label }}</span>
                        {% for highlight in metadataLabelWithHighlights.highlights %}
                            {{ highlight }}
                        {% endfor %}
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            {% for collapsedMetadataLabelWithValue in collapsedMetadataLabelsWithValues %}
                <div class="metadata-details {{ loop.first ? 'text-container': '' }}">
                    <span class="metadata-label
                                {{ loop.first ? 'text-container': '' }}">{{ collapsedMetadataLabelWithValue.label }}:</span>
                    {{ collapsedMetadataLabelWithValue.value }}
                </div>
            {% endfor %}
        {% endif %}
    </div>
    {% endif %}
</div>
