{% extends resource.resourceClass == 'books' and canView(resource) ? 'redo/layout.twig' : 'empty.twig' %}

{% set page_title = resource | metadata('label') %}
{% set childrenAllowed = resource | childrenAllowed %}

{% block content %}
    {% include "redo/title-bar.twig" %}
    {% include "redo/menu.twig" %}

    {% if resource | metadata('parent') | first %}
        <div class="breadcrumbs">
            {{ 'Collection' | trans }}:
            {% embed "redo/resource-details/ancestors-list.twig" %}
                {% block itemSuffix %}
                    &gt;
                {% endblock %}
            {% endembed %}
            {{ resource | metadata('label') }}
        </div>
    {% endif %}

    {% set referer = app.request.headers.get('referer') %}
    {% if referer starts with app.request.schemeAndHttpHost ~ '/search' %}
        <a class="link-to-the-previous-page"
            href="{{ referer }}">{{ icon('undo-3') }}{{ 'Back to search results' | trans }}</a>
    {% endif %}

    <div class="resource-details">
        <div class="top-container">
            <div class="resource-image-with-title-container-with-actions">
                {% include 'redo/resource-image-placeholder.twig' %}
                <div class="title-container-with-actions">
                    <div class="title-container">
                        <h1>{{ resource | metadata('label') | raw }}</h1>
                        Typ: {{ resource.kind.label | inCurrentLanguage }}
                    </div>
                    <div class="actions">
                        <button title="{{ 'Add to favorites' | trans }}">{{ icon('bookmark', 2) }}</button>
                        {% if childrenAllowed %}
                            <a href="/resources/{{ resource.id }}/rss"
                                title="{{ 'Resource RSS channel' | trans }}">{{ icon('rss', 1.75) }}</a>
                        {% endif %}
                        <button title="{{ 'Report an issue with the resource' | trans }}">{{ icon('mail', 2 ) }}</button>
                        <div class="share-buttons">
                            <button title="{{ 'Share on Twitter' | trans }}">{{ icon('twitter', 2) }}</button>
                            <button title="{{ 'Share on Facebook' | trans }}">{{ icon('facebook', 2) }}</button>
                            <button title="{{ 'Share on Google+' | trans }}">{{ icon('google+', 2) }}</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="download-options-container">
                <div class="download-options">
                    <span class="download-options-icon">{{ icon('download', 1.5) }}</span>
                    <fieldset>
                        <legend align="left"><span title="{{ 'Download resource' | trans }}">{{ 'Download resource' | trans }}</span>
                        </legend>
                        <div class="download-formats">
                            <h4><a href="/download/mobi"
                                    title="{{ 'Download resource in MOBI format' | trans }} - 7KB">MOBI</a></h4>
                            <h4><a href="/download/pdf"
                                    title="{{ 'Download resource in PDF format' | trans }} - 144000KB">PDF</a></h4>
                        </div>
                    </fieldset>
                </div>
                <div class="download-options">
                    <span class="download-options-icon">{{ icon('examination', 1.5) }}</span>
                    <fieldset>
                        <legend align="left"><span title="{{ 'Cite resource' | trans }}">{{ 'Cite resource' | trans }}</span></legend>
                        <div class="download-formats in-one-line">
                            <h4><a href="/resources/{{ resource.id }}/bibtex"
                                    title="{{ 'Download resource data in BibTeX format' | trans }}">BibTeX</a></h4>
                            <h4><a href="/resources/{{ resource.id }}/endnote"
                                    title="{{ 'Download resource data in EndNote format' | trans }}">EndNote</a></h4>
                            <h4><a href="/resources/{{ resource.id }}/iso-690"
                                    title="{{ 'Download resource data in ISO 690 format'
                                    | trans }}">{{ icon('double-quote-sign', 1.25) }}</a></h4>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
        <div class="details-container">
            {% for metadataGroupId, metadataList in resource.kind.groupedMetadataList %}
                {% set metadataGroup = metadataGroup(metadataGroupId) %}
                <div class="title-with-separator">
                    <strong>
                        {% if metadataGroup.label is defined %}
                            {{ metadataGroup.label | inCurrentLanguage }}
                        {% else %}
                            {{ 'Additional information' | trans }}
                        {% endif %}
                    </strong>
                    <hr>
                </div>
                <dl>
                    {% for metadata in metadataList if metadata.id > 0
                        and metadata.control != 'display-strategy'
                        and metadata.control != 'wysiwyg-editor' %}
                        {% set metadataValues = resource | metadata(metadata.id) | onlyMetadataInCurrentLanguage(metadata) %}
                        {% if metadataValues | length %}
                            <dt>
                                {{ metadata.label | inCurrentLanguage }}
                            </dt>
                            <dd>
                                {% for metadataValue in metadataValues %}
                                    {% if metadata.control == 'file' or metadata.control == 'directory' %}
                                        {{ metadataValue | basename }}
                                    {% elseif metadata.control == 'relationship' %}
                                        {% set relatedResource = resource(metadataValue) %}
                                        {% if relatedResource.resourceClass == 'books' and canView(relatedResource) %}
                                            <a href="/resources/{{ relatedResource.id }}">{{ relatedResource | mLabel | raw }}</a>
                                        {% elseif canViewTeaser(relatedResource) %}
                                            {{ relatedResource | mLabel | raw }}
                                        {% endif %}
                                    {% elseif metadata.dynamic %}
                                        {{ metadataValue | raw }}
                                    {% else %}
                                        {{ metadataValue }}
                                    {% endif %}
                                    {% if not loop.last %}
                                        <br>
                                    {% endif %}
                                {% endfor %}
                            </dd>
                        {% endif %}
                    {% endfor %}
                </dl>
            {% endfor %}
        </div>
        {% if childrenAllowed %}
            <div class="child-resources">
                {% set page = app.request.query.get('page') | default(1) %}
                {% set childrenPerPage = 10 %}
                {% set children = resources({parentId: resource.id, page: page, resultsPerPage: childrenPerPage}) %}
                {% set pagination = paginate(page, childrenPerPage, children.getTotalCount) %}
                <div class="title-with-separator">
                    <h3><strong>{{ 'Collection items' | trans }} ({{ children.getTotalCount }})</strong></h3>
                    <hr>
                </div>
                <div class="resources-list">
                    {% for resource in children %}
                        {% include "redo/resources-list-element.twig" %}
                        {% if not loop.last %}
                            <hr>
                        {% endif %}
                    {% endfor %}
                </div>
                {% include "redo/search/pagination.twig" with {'pagination': pagination, 'route_params': {'resourceId':
                    resource.id}} %}
            </div>
        {% endif %}
    </div>
    {% include "redo/footer.twig" %}
{% endblock %}
